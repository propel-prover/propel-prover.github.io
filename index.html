<!DOCTYPE html>
<html>
<head>
<title>Propel</title>
<meta charset="utf8">
<link rel="icon" type="image/png" href="/favicon.png">
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<header>
    <div id="logo">
        <img src="logo.svg" width="200px">
    </div>

    <ul>
        <li><a href="https://programming-group.com">Programming Group</a></li>
        <li><a href="https://github.com/propel-prover">GitHub</a></li>
    </ul>
</header>

<ul id="nav">
    <li><a href="#section-crdt">CRDTs</a></li>
    <li><a href="#section-properties">Properties</a></li>
    <li><a href="#section-getting-started">Getting Started</a></li>
    <li><a href="#section-scala-dsl">Scala DSL</a></li>
    <li><a href="#section-publications">Publications</a></li>
</ul>

<div id="jumbo">
    <div id="interactiveCode">
        <h1>Try Propel</h1>
        <h2>Check the commutativity, associativity, idempotency, and other algebraic properties of
        your binary functions and relations in the browser</h2>
        <div id="autocomplete"><!--{{{-->
            <div class="hint">Use the Up/Down arrow to cycle through the options. Click Enter to introduce the syntactic form. Click ESC to close popup</div>
            <div id="syntax">
            <h3>Expressions</h3>
            <ul>
                <li class="selected">
                    <code>(lambda [<em>prop...</em>] <em>arg...</em> <em>expr</em>)</code>
                    <div class="description">
                    A lambda expression with zero or more <em>properties</em>, one or more arguments of the form <code>(var type)</code>, and an expression.
                    The annotated properties are type checked and will be part of the function's type.
                    </div>
                </li>
                <li>
                    <code>(letrec <em>var</em> <em>type</em> <em>expr</em>)</code>
                    <div class="description">
                    Introduces a recursive definition bound to <em>var</em> that has the designated type and an expression.
                    Thus the identifier <em>var</em> is bound, and can be used, in <em>expr</em>
                    </div>
                </li>
                <li>
                    <code>(cases <em>expr</em> <em>[pattern expr]...</em>)</code>
                    <div class="description">
                    Perform a pattern match on the result of the first expression.
                    Cases are surrounded by square brackets and each case has one pattern and one expression to be executed if the case matches.
                    Free variables in patterns are bound as expected.
                    </div>
                </li>
                <li>
                    <code>(let <em>pattern</em> <em>expr</em> <em>expr</em>)</code>
                    <div class="description">
                    Introduces a definition for each free variable in a given pattern (that must be exhaustive) that matches the first expression in the second expression.
                    Non-trivial patterns are useful when a type has only one constructor, for example <code>Tuple</code>.
                    </div>
                </li>
                <li>
                    <code>(if <em>expr</em> <em>expr</em> <em>expr</em>)</code>
                    <div class="description">
                    Performs a conditional check. The first expression is expected to reduce to either <code>True</code> or <code>False</code>
                    </div>
                </li>
                <li>
                    <code>(not <em>expr</em>)</code>
                    <div class="description">
                    Negates the booleans <code>True</code> or <code>False</code>
                    </div>
                </li>
                <li>
                    <code>(and <em>expr</em> <em>expr</em>)</code>
                    <div class="description">
                    Computes the conjunction of two booleans
                    </div>
                </li>
                <li>
                    <code>(or <em>expr</em> <em>expr</em>)</code>
                    <div class="description">
                    Computes the disjunction of two booleans
                    </div>
                </li>
                <li>
                    <code>(implies <em>expr</em> <em>expr</em>)</code>
                    <div class="description">
                    Computes the implication between two booleans where the first expression is the antecedent and the second expression is the consequent.
                    </div>
                </li>
            </ul>

            <h3>Definitions</h3>
            <ul>
                <li>
                    <code>(def <em>var</em> [<em>type...</em>] <em>expr</em>)</code>
                    <div class="description">
                    Introduces a definition bound to <em>var</em>.
                    Recursive definitions must designate their type.
                    Non-recursive definitions leave out the type declaration.
                    <em>var</em> will be bound to the value of <em>expr</em> in the rest of the program.
                    </div>
                </li>
                <li>
                    <code>(type <em>var</em> <em>type</em>)</code>
                    <div class="description">
                    Introduce a recursive or non-recursive type alias.
                    <em>var</em> will be bound to <em>type</em> in the rest of the program.
                    </div>
                </li>
            </ul>

            <h3>Patterns</h3>
            <ul>
                <li>
                    <code>var</code>
                    <div class="description">
                    A pattern that will bind to everything.
                    </div>
                </li>
                <li>
                    <code>(<em>K</em> <em>pattern...</em>)</code>
                    <div class="description">
                    A pattern that will only match expressions constructed with the constructor <em>K</em> and whose arguments match each subpattern.
                    </div>
                </li>
            </ul>

            <h3>Properties</h3>
            <ul>
                <li>
                    <code>comm</code>
                    <div class="description">
                    Commutativity: <code>(f x y) = (f y x)</code>
                    </div>
                </li>
                <li>
                    <code>assoc</code>
                    <div class="description">
                    Associativity: <code>(f (f x y) z) = (f x (f y z))</code>
                    </div>
                </li>
                <li>
                    <code>idem</code>
                    <div class="description">
                    Idempotency: <code>f x x = x</code>
                    </div>
                </li>
                <li>
                    <code>sel</code>
                    <div class="description">
                    Selectivity: <code>f x y = x</code> or <code>f x y = y</code>
                    </div>
                </li>
                <li>
                    <code>refl</code>
                    <div class="description">
                    Reflexivity: <code>f x x = True</code>
                    </div>
                </li>
                <li>
                    <code>irefl</code>
                    <div class="description">
                    Irreflexivity: <code>f x x = False</code>
                    </div>
                </li>
                <li>
                    <code>sym</code>
                    <div class="description">
                    Symmetry: If <code>f x y = True</code> then <code>f y x = True</code>
                    </div>
                </li>
                <li>
                    <code>antisym</code>
                    <div class="description">
                    Antisymmetry: If <code>f x y = True</code> and <code>f y x = True</code> then <code>x = y</code>
                    </div>
                </li>
                <li>
                    <code>asym</code>
                    <div class="description">
                    Assymetry: If <code>f x y = True</code> then <code>f y x = False</code>
                    </div>
                </li>
                <li>
                    <code>conn</code>
                    <div class="description">
                    Connectedness: <code>f x y = True</code> or <code>f y x = True</code>
                    </div>
                </li>
                <li>
                    <code>trans</code>
                    <div class="description">
                    Transitivity: If <code>f x y = True</code> and <code>f y z = True</code> then <code>f x z = True</code>
                    </div>
                </li>
            </ul>

            <h3>Types</h3>
            <ul>
                <li>
                    <code><em>var</em></code>
                    <div class="description">
                    A type identifier as defined through <code>type</code>, or a type variable as bound by <code>rec</code> and <code>forall</code>
                    </div>
                </li>
                <li>
                    <code>{<em>constructor...</em>}</code>
                    <div class="description">
                    Defines a tagged union defined by at least one constructor.
                    Additionally, if constructors take arguments, then each argument's type must be present alongside the constructor inside parenthesis.
                    </div>
                </li>
                <li>
                    <code>(rec <em>var</em> <em>type</em>)</code>
                    <div class="description">
                    Defines a recursive type.
                    <em>var</em> will be bound to the recursive type inside <em>type</em>.
                    </div>
                </li>
                <li>
                    <code>(forall <em>var</em> <em>type</em>)</code>
                    <div class="description">
                    Defines a polymorphic type.
                    <em>var</em> is bound in <em>type</em>
                    </div>
                </li>
            </ul>
            </div>
            <div id="selected-description">
            </div>
        <!--}}}--></div>
        <div id="controls">
            <input type="button" value="Check" id="checkCode"></input>
            <select id="example">
                <option value="bv_eq" selected>BitVector equality</option>
                <option value="nat_add3p">Peano Number addition</option>
                <option value="natlist_gcounter">GCounter merge</option>
            </select>
            <input type="checkbox" id="printReduction">
            <label for="printReduction">Print reductions</label>
            <input type="checkbox" id="printDeduction">
            <label for="printDeduction">Print deductions</label>
            <input type="checkbox" id="checkOnInput">
            <label for="checkOnInput">Check on change</label>
        </div>
        <div id="codeAndConsole">
            <div id="codewrapper">
                <pre id="viewer"></pre>
                <textarea id="editor" spellcheck="false"></textarea>
            </div>
            <div id="consoleContainer">
                <pre id="console">Click on 'Check' to start the checking</pre>
            </div>
        </div>
        <div id="status"><br></div>
    </div>
</div>

<main>
    <h1 id="section-crdt">Conflict-Free Replicated Data-Types (CRDT)</h1>
    <p>
    A state-based Conflict-Free Replicated Data-Type (CRDT) is any datatype that defines a <code>merge</code> function that combines any two instances&mdash;any two replicas&mdash;into one without any conflict or manual conflict resolution.
    We expect the two following properties to hold:
    </p>
    <ol>
        <li>The order of merging any number of replicas should not change the result, and</li>
        <li>merging a replica with itself must not introduce any change to that replica, i.e. the replica remains constant.</li>
    </ol>
    <p>
    When applied to two replicas the first property entails that <code>merge</code> must be <em>commutative</em>.
    When applied to three or more replicas the first property entails that <code>merge</code> must be <em>associative</em>.
    And the second property entails that <code>merge</code> must be <em>idempotent</em>.
    </p>

    <p>
    <strong>How do we guarantee that implementations of <code>merge</code> satisfy these properties?</strong>
    The state of the art is to verify models of these CRDTs manually or automatically by instantiating some framework.
    Other works have developed code synthesizers that generate a <code>merge</code> function with the required properties given the desired semantics.
    Both approaches limit developers.
    Our solution is to develop a type-system that tracks these properties and a compiler that can prove these properties at compile-time.
    </p>

    <h1 id="section-properties">Properties We Support</h1>
    <h2>Binary Functions</h2>
    <div class="prop_box">
    <div class="prop_card">
        <img src="/diagrams/comm.svg">
        <h3>Commutativity</h3>
        <p>A commutative function is one whose arguments can be given in any order without changing the result</p>
        <h4>E.g. Average of two numbers</h4>
    </div>
    <div class="prop_card">
        <img src="/diagrams/idem.svg">
        <h3>Idempotency</h3>
        <p>If an idempotent function is called with the same argument it must return it</p>
        <h4>E.g. Set union</h4>
    </div>
    <div class="prop_card">
        <img src="/diagrams/assoc.svg">
        <h3>Associativity</h3>
        <p>An associative function is one that can be folded in any direction on arguments without changing the result</p>
        <h4>E.g. Matrix multiplication</h4>
    </div>
    <div class="prop_card">
        <img src="/diagrams/sel.svg">
        <h3>Selectivity</h3>
        <p>A selective function must always return one of its arguments</p>
        <h4>E.g. Maximum of two numbers</h4>
    </div>
    </div>


    <h2>Binary Relations</h2>
    <div class="prop_box">
        <div class="prop_card">
            <img src="/diagrams/refl.svg">
            <h3>Reflexivity</h3>
            <p>A reflexive relation is one where every element is related to itself</p>
            <h4>E.g. Equality</h4>
        </div>
        <div class="prop_card">
            <img src="/diagrams/sym.svg">
            <h3>Symmetric</h3>
            <p>A symmetric relation is one where an element is related to another if and only if the other is related to it</p>
            <h4>E.g. Inequality</h4>
        </div>
        <div class="prop_card">
            <img src="/diagrams/trans.svg">
            <h3>Transitivity</h3>
            <p>In a transitive relation if an element <em>a</em> is related to <em>b</em> and <em>b</em> is related to <em>c</em> then <em>a</em> must be related to <em>c</em></p>
            <h4>E.g. Ancestry</h4>
        </div>
        <div class="prop_card">
            <img src="/diagrams/conn.svg">
            <h3>Connectivity</h3>
            <p>A connected relation is one where between any two distinct elements some relation exists</p>
            <h4>E.g. Total order</h4>
        </div>
        <div class="prop_card">
            <img src="/diagrams/antisym.svg">
            <h3>Antisymmetry</h3>
            <p>An antisymmetric relation is one where between any two distinct elements at moste one relation exists</p>
            <h4>E.g. Divisibility</h4>
        </div>
    </div>

    <h1 id="section-getting-started">Getting Started</h1>

<h2>Building and Loading the Propel Docker image</h2>

<p>
We provide you with <code>propel.tar.xz</code> on <a href="https://doi.org/10.5281/zenodo.7817421">Zenodo (doi: 10.5281/zenodo.7817421)</a>, which is a pre-built container image that contains all necessary programs.
To load, run the following command:
<br><code>
$ docker load < propel.tar.xz
</code>
</p>

<p>
Further, we also provide the option to build the contain anew. To build, run the
following command which takes between 10 and 20 minutes:
<br><code>
$ docker build -t propel .
</code>
</p>

<p>
Rebuilding the image may not work on Apple M1 machines because of incomplete emulation of system calls (specifically the <code>inotify</code> kernel subsystem).
Hence, we recommend rebuilding the image on a platform fully supported by Docker, like x86-64 systems.
</p>

<h2>Compiling Propel</h2>
<p>
The provided container already contains a binary executable of Propel.
</p>

<p>
To compile Propel to Java bytecode yourself, run the following command:
<br><code>
$ docker run -it --rm propel bash -c 'cd /propel; sbt clean compile'
</code>
</p>

<p>
To compile Propel to a native binary yourself, run the following command:
<br><code>
$ docker run -it --rm propel bash -c 'cd /propel; sbt clean nativeLink'
</code>
</p>

<p>
Compiling Propel, to bytecode or to a native executable, may not work inside the Docker container on Apple M1 machines for the reasons mentioned earlier.
</p>

<p>
The resulting binary is at <code>/propel/.native/target/scala-3.2.2/propel</code>.
The <code>propel</code> executable in the <code>$PATH</code> is already symlinked to that binary file.
Hence, by default, you can just run <code>propel</code>.
</p>


    <h1 id="section-scala-dsl">Scala DSL</h1>
<h2>Code Examples</h2>

<h2>From the Propel Docker image</h2>
<p>
Propel is also provided as a DSL in Scala.
To experiment with the DSL, we invite you take a look into the following files in the <a href="https://doi.org/10.5281/zenodo.7817421">Propel Docker image</a>:
<code>/propel/src/test/scala/propel/ScalaExamplesNat.scala</code>,
<code>/propel/src/test/scala/propel/ScalaExamplesNum.scala</code> and
<code>/propel/src/test/scala/propel/ScalaExamplesList.scala</code> inside the container.
</p>

<p>
As an example, you can execute the following commands to run a shell, explore the files and recompile the project:
<code><pre>
$ docker run -it --rm propel bash                               # open a shell
$ nano /propel/src/test/scala/propel/ScalaExamplesList.scala    # open the file

# edit and save the file
$ cd /propel && sbt Test/compile                                # recompile
</pre></code>

<p>
Compiling the examples may not work inside the Docker container on Apple M1 machines for the reasons mentioned earlier.
</p>

<p>
You may define your own function using the following syntax:
<code><pre>
def myFunction = prop[(FunctionProperties) ::= (T1, T1) =>: T2] { (x, y) => body }
// or
def myRecursiveFunction = prop.rec[(FunctionProperties) ::= (T1, T1) =>: T2] { myRecursiveFunction => (x, y) => body }
</pre></code>
Here, <code>myFunction</code> is the name of the function, <code>FunctionProperties</code> is a list of function properties the function has (separated by <code>&</code>), <code>T1</code> is the type of the arguments of the binary function, <code>T2</code> is the return type of the function, <code>x</code> and <code>y</code> are the names of the function arguments, and <code>body</code> is the function body.
</p>

<p>
The function properties are chosen from the following list: <code>Comm</code>, <code>Assoc</code>, <code>Idem</code>, <code>Sel</code>, <code>Refl</code>, <code>Antisym</code>, <code>Trans</code>, <code>Conn</code>, and <code>Sym</code>.
</p>

<p>
If Propel is able to prove the properties that the function is annotated with, then compilation succeeds.
If the properties cannot be proven, then a compilation error indicates which property could not be proven.
</p>

<p>
For example, you can add the following GCounter CRDT example to one of the files in <code>/propel/src/test/scala/propel</code>
<code><pre>
def mergeGCounter = prop[(Comm & Assoc & Idem) := (List[Num], List[Num]) =>: List[Num]] { (x, y) => zipWith(maxNum)(x, y) }
</pre></code>
</p>


    <h1 id="section-publications">Publications</h1>
    <ol class="publications">
        <li>George Zakhour, Pascal Weisenburger, and Guido Salvaneschi. 2023. Type-Checking CRDT Convergence.
            In <em>Proceedings of the 44th ACM SIGPLAN Conference on Programming Language Design and Implementation</em>, PLDI, June 17-21, 2023, Orlando, Florida, United States. <a href="https://doi.org/10.1145/3591276">https://doi.org/10.1145/3591276</a> [<a href="https://programming-group.com/assets/pdf/papers/2023_Type-Checking-CRDT-Convergence.pdf">author version</a>]</li>
    </ol>
</main>

<footer>
Propel is a research language developed at the <a href="https://programming-group.com">Programming Group</a>
&copy; 2023
</footer>

<script type="text/propel" id="bv_eq">
; type definitions
(type bitvec (rec x {(B0 x) (B1 x) BZ}))
(type bool {True False})

; definition of equality over bitvectors
(def bv_eq (fun bitvec bitvec bool)
  ; it must be reflexive, transitive, and antisymmetric
  (lambda [refl trans antisym] (x bitvec) (y bitvec)
    (cases (Tuple x y)
        [(Tuple BZ BZ) True]
        [(Tuple (B0 x) (B0 y)) (bv_eq x y)]
        [(Tuple (B1 x) (B1 y)) (bv_eq x y)]
        [_ False])))
</script>

<script type="text/propel" id="nat_add3p">
; type definitions
(type nat (rec x {(S x) Z}))

; definition of addition over the natural numbers
(def nat_add3p (fun nat nat nat)
  ; it must be commutative and associative
  (lambda [comm assoc] (x nat) (y nat)
    (cases (Tuple x y)
        [(Tuple Z y) y]
        [(Tuple x Z) x]
        [(Tuple (S x) (S y)) (S (S (nat_add3p x y)))])))
</script>

<script type="text/propel" id="natlist_gcounter">
; type definitions
(type nat (rec x {(S x) Z}))
(type list (rec x {(Cons nat x) Nil}))

; definition of maximum over the natural numbers
(def nat_max (fun nat nat nat)
  ; it must be idempotent, commutative, and associative
  (lambda [idem comm assoc] (x nat) (y nat)
    (cases (Tuple x y)
      [(Tuple Z y) y]
      [(Tuple x Z) x]
      [(Tuple (S x) (S y)) (S (nat_max x y))])))

; definition of the merge function of a GCounter
(def natlist_gcounter (fun list list list)
  ; it must be idempotent, commutative, and associative
  (lambda [idem comm assoc] (x list) (y list)
    (cases (Tuple x y)
      [(Tuple Nil y) y]
      [(Tuple x Nil) x]
      [(Tuple (Cons x xs) (Cons y ys))
       (Cons (nat_max x y) (natlist_gcounter xs ys))])))
</script>

<script src="editor.js"></script>
</body>
</html>
